{"version":3,"sources":["../src/edit_note.js"],"names":["define","$","ajax","templates","notification","str","cfg","url","on","e","type","keyCode","stopImmediatePropagation","preventDefault","target","mainelement","closest","addSpinner","element","addClass","spinner","find","length","show","attr","imageUrl","append","removeSpinner","removeClass","hide","updateValue","value","pendingId","join","M","util","js_pending","call","methodname","args","baid","note","done","data","oldvalue","render","html","js","newelement","replaceNode","focus","trigger","ajaxreturn","js_complete","fail","ex","Event","exception","newvalue","isDefaultPrevented","turnEditingOff","el","off","removeAttr","turnEditingOn","uniqueId","prefix","idlength","uniqid","i","Math","floor","random","get_string","s","instr","inputelement","val","text","lbl","select","behatsiterunning"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AJAX helper for the inline editing a value.\n *\n * This script is automatically included from template core/inplace_editable\n * It registers a click-listener on [data-inplaceeditablelink] link (the \"inplace edit\" icon),\n * then replaces the displayed value with an input field. On \"Enter\" it sends a request\n * to web service core_update_inplace_editable, which invokes the specified callback.\n * Any exception thrown by the web service (or callback) is displayed as an error popup.\n *\n * @module     mod_booking/edit_note\n * @package    mod_booking\n * @copyright  2018 David Bogner\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.3\n */\ndefine(['jquery',\n    'core/ajax',\n    'core/templates',\n    'core/notification',\n    'core/str',\n    'core/config',\n    'core/url'],\n    function($, ajax, templates, notification, str, cfg, url) {\n        $('body').on('click keypress', '[data-inplaceeditable]', function(e) {\n            if (e.type === 'keypress' && e.keyCode !== 13) {\n                return;\n            }\n            e.stopImmediatePropagation();\n            e.preventDefault();\n            var target = $(this),\n            mainelement = target.closest('[data-inplaceeditable]');\n            var addSpinner = function(element) {\n                element.addClass('updating');\n                var spinner = element.find('img.spinner');\n                if (spinner.length) {\n                    spinner.show();\n                } else {\n                    spinner = $('<img/>')\n                    .attr('src', url.imageUrl('i/loading_small'))\n                    .addClass('spinner').addClass('smallicon');\n                    element.append(spinner);\n                }\n            };\n\n            var removeSpinner = function(element) {\n                element.removeClass('updating');\n                element.find('img.spinner').hide();\n            };\n\n            var updateValue = function(mainelement, value) {\n                var pendingId = [\n                    mainelement.attr('data-baid'),\n                    'pending',\n                    ].join('-');\n                M.util.js_pending(pendingId);\n                addSpinner(mainelement);\n                ajax\n                .call([{\n                    methodname: 'mod_booking_update_bookingnotes',\n                    args: {\n                        baid: mainelement.attr('data-baid'),\n                        note: value\n                    },\n                    done: function(data) {\n                        var oldvalue = mainelement.attr('data-value');\n                        templates.render('mod_booking/edit_bookingnotes', data).done(function(html, js) {\n                            var newelement = $(html);\n                            templates.replaceNode(mainelement, newelement, js);\n                            newelement.find('[data-note]').focus();\n                            newelement.trigger({type: 'updated', ajaxreturn: data, oldvalue: oldvalue});\n                            M.util.js_complete(pendingId);\n                        });\n                    },\n                    fail: function(ex) {\n                        var e = $.Event('updatefailed', {\n                            exception: ex,\n                            newvalue: value\n                        });\n                        removeSpinner(mainelement);\n                        M.util.js_complete(pendingId);\n                        mainelement.trigger(e);\n                        if (!e.isDefaultPrevented()) {\n                            notification.exception(ex);\n                        }\n                    }\n                }], true);\n            };\n            var turnEditingOff = function(el) {\n                el.find('textarea').off();\n                el.html(el.attr('data-oldcontent'));\n                el.removeAttr('data-oldcontent');\n                el.removeClass('inplaceeditingon');\n                el.find('[data-note]').focus();\n            };\n\n            var turnEditingOn = function(el) {\n                el.attr('data-oldcontent', el.html());\n\n                var uniqueId = function(prefix, idlength) {\n                    var uniqid = prefix,\n                    i;\n                    for (i = 0; i < idlength; i++) {\n                        uniqid += String(Math.floor(Math.random() * 10));\n                    }\n                    // Make sure this ID is not already taken by an existing element.\n                    if ($(\"#\" + uniqid).length === 0) {\n                        return uniqid;\n                    }\n                    return uniqueId(prefix, idlength);\n                };\n\n                str.get_string('edittitleinstructions').done(function(s) {\n                    var instr = $('<span class=\"editinstructions\">' + s + '</span>').\n                    attr('id', uniqueId('id_editinstructions_', 20)),\n                    inputelement = $('<textarea rows=\"4\" cols=\"50\"></textarea>').\n                    attr('id', uniqueId('id_inplacevalue_', 20)).\n                    val(el.find('.bookingnote').text()).\n                    attr('aria-describedby', instr.attr('id')).\n                    addClass('ignoredirty').\n                    addClass('form-control'),\n                    lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>').\n                    attr('for', inputelement.attr('id'));\n                    el.html('').append(instr).append(lbl).append(inputelement);\n                    inputelement.focus();\n                    inputelement.select();\n                    inputelement.on('keyup keypress focusout', function(e) {\n                        if (cfg.behatsiterunning && e.type === 'focusout') {\n                            // Behat triggers focusout too often.\n                            return;\n                        }\n                        if (e.type === 'keypress' && e.keyCode === 13) {\n                            // We need 'keypress' event for Enter because keyup/keydown would catch Enter that was\n                            // pressed in other fields.\n                            var val = inputelement.val();\n                            turnEditingOff(el);\n                            updateValue(el, val);\n                        }\n                        if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\n                            // We need 'keyup' event for Escape because keypress does not work with Escape.\n                            turnEditingOff(el);\n                        }\n                    });\n                });\n            };\n            turnEditingOn(mainelement);\n        });\n        return {};\n    });\n"],"file":"edit_note.min.js"}